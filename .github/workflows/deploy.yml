name: Build and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io

jobs:
  # ===========================================
  # Build Backend Image
  # ===========================================
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-name: ${{ steps.image-name.outputs.backend }}
      image-tag: ${{ steps.image-name.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image-name
        run: |
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "backend=${REPO_LC}/backend" >> $GITHUB_OUTPUT
          echo "frontend=${REPO_LC}/frontend" >> $GITHUB_OUTPUT
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image-name.outputs.backend }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./docker/backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

  # ===========================================
  # Build Frontend Image
  # ===========================================
  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-name: ${{ steps.image-name.outputs.frontend }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image-name
        run: |
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "frontend=${REPO_LC}/frontend" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image-name.outputs.frontend }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./docker/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production
          build-args: |
            API_URL=${{ secrets.API_URL }}

  # ===========================================
  # Security Scanning
  # ===========================================
  security-scan:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
      actions: read

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner on Backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ needs.build-backend.outputs.image-name }}:${{ needs.build-backend.outputs.image-tag }}
          format: 'sarif'
          output: 'backend-trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Run Trivy vulnerability scanner on Frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ needs.build-frontend.outputs.image-name }}:${{ needs.build-backend.outputs.image-tag }}
          format: 'sarif'
          output: 'frontend-trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Backend scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'backend-trivy-results.sarif'
          category: 'trivy-backend'
        continue-on-error: true

      - name: Upload Frontend scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'frontend-trivy-results.sarif'
          category: 'trivy-frontend'
        continue-on-error: true

  # ===========================================
  # Deploy to VPS
  # ===========================================
  deploy:
    needs: [build-backend, build-frontend, security-scan]
    runs-on: ubuntu-latest
    environment: env

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          errors=0
          for var in VPS_HOST VPS_USER VPS_SSH_KEY APP_KEY DB_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not set"
              errors=$((errors + 1))
            fi
          done
          if [ $errors -gt 0 ]; then
            echo "::error::Missing $errors required secrets"
            exit 1
          fi
          echo "All required secrets are configured"

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.prod.yml,docker/scheduler/"
          target: "/opt/novika"

      - name: Set lowercase repository name and short SHA
        id: repo
        run: |
          echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "short_sha=$(echo '${{ github.sha }}' | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/novika

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Create .env file from secrets with secure permissions
            umask 077
            cat > .env << 'ENVEOF'
            # Application
            APP_KEY=${{ secrets.APP_KEY }}
            LOG_LEVEL=info
            API_URL=${{ secrets.API_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}

            # Database
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=${{ secrets.DB_DATABASE }}

            # Redis
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

            # External APIs
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            MISTRAL_API_KEY=${{ secrets.MISTRAL_API_KEY }}
            INWORLD_API_KEY=${{ secrets.INWORLD_API_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}

            # Image tag
            TAG=${{ steps.repo.outputs.short_sha }}
            GITHUB_REPOSITORY=${{ steps.repo.outputs.name }}
            ENVEOF
            chmod 600 .env

            # Pull new images
            docker compose -f docker-compose.prod.yml pull

            # Build scheduler image (uses backend image as base)
            docker compose -f docker-compose.prod.yml build scheduler

            # Run database migrations
            docker compose -f docker-compose.prod.yml run --rm backend node ace migration:run --force

            # Start all services
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # Clean up old images
            docker image prune -af --filter "until=24h"

            # Wait for services to start
            sleep 30

            # Debug: Show container status
            echo "=== Container Status ==="
            docker compose -f docker-compose.prod.yml ps

            # Debug: Show backend logs
            echo "=== Backend Logs (last 30 lines) ==="
            docker compose -f docker-compose.prod.yml logs --tail=30 backend

            # Debug: Show worker logs (in case of restart issues)
            echo "=== Worker Logs (last 30 lines) ==="
            docker compose -f docker-compose.prod.yml logs --tail=30 worker

            # Verify deployment with retry (backend is internal, check via docker)
            echo "=== Health Check ==="
            for i in 1 2 3 4 5; do
              echo "Health check attempt $i..."
              if docker compose -f docker-compose.prod.yml exec -T backend node -e "require('http').get('http://localhost:3333/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"; then
                echo "Health check passed!"
                break
              fi
              if [ $i -eq 5 ]; then
                echo "Health check failed after 5 attempts"
                echo "=== Final Container Status ==="
                docker compose -f docker-compose.prod.yml ps
                exit 1
              fi
              echo "Retrying in 10 seconds..."
              sleep 10
            done

            echo "Deployment completed successfully!"
